# Stable Rate Patch

## Summary

Repository containing different developments concerning the Aave incident described [HERE](https://governance.aave.com/t/aave-v2-v3-security-incident-04-11-2023/15335/26).

- Stable Debt Token upgraded implementations, stopping minting.
- Liquidations Grace Sentinel.

## Liquidations Grace Sentinel

The Liquidation Grace Sentinel is a new feature introduced into Aave v2, allowing for the Aave Guardian to granularly (per asset) set a "grace period" for an asset.
An asset being in "grace period" implies that liquidations involving it as collateral OR repaid debt can't be processed, so factually is a less aggressive pool-wide pause.

The main objective of this mechanism, is to allow a gracefully unpause of an Aave v2 pool: if market conditions allow, a grace period of X minutes/hours/days can be set for when a pool will be unpaused.

Same as with the pause mechanism (as they are complementary), the usage of the liquidation grace sentinel will be allowed only for the current `emergencyAdmin`` of the Aave v2 pool: the Aave Guardian.

### Technical details

- In order to activate a grace period, the `setGracePeriods()` on `LiquidationsGraceSentinel` should be called with the assets affected, and timestamps in the future until which the grace period will be triggered.
  This should be done before the unpause.
- The Liquidations Grace Sentinel requires an upgrade on the `LendingPoolCollateralManager` of Aave v2, introducing the condition to validate grace periods.
- The `LiquidationsGraceSentinel` for Aave v2 Ethereum can be found on [https://etherscan.io/address/0x929b090FD0E12Aa5F6863f71037f8B23Cd1DE633](https://etherscan.io/address/0x929b090FD0E12Aa5F6863f71037f8B23Cd1DE633).

## Diffs

All the diffs between the etherscan downloaded and modified contracts can be found [HERE](./diffs). These include both the source code diffs and the storage layout diffs. The storage layout diff files end with `layout_diffs`.

All the files downloaded from etherscan are stored [HERE](./etherscan)

Various diffs have also been created among all the different aave v2 stable debt tokens on ethereum against a reference, which can be found over [HERE](./diffs/v2EthStableDebtAll). The reference is [stable debt token of DAI](https://etherscan.io/address/0xD23A44eB2db8AD0817c994D3533528C030279F7c). Looking at the diffs we can conclude that there is no major difference in different stable debt impl for various tokens on aave v2 ethereum, except for `AMPL` token which is not being upgraded.

The diffs among different aave v3 stable debt tokens have also been added over here: [v3PolArbStableDebtToken](diffs/v3PolArbStableDebtToken.md), [v3PolAvaStableDebtToken](diffs/v3PolAvaStableDebtToken.md), [v3PolOptStableDebtToken](diffs/v3PolOptStableDebtToken.md). We can conclude that there is no diffs between different v3 stable debt tokens across networks.

The diffs among different aave v2 pool configurators can be found here: [v2EthPolPoolConfigurator](diffs/v2EthPolPoolConfigurator.md), [v2PolAvaPoolConfigurator](diffs/v2PolAvaPoolConfigurator.md), [v2EthAvaPoolConfigurator](diffs/v2EthAvaPoolConfigurator.md), [v2EthAmmEthPoolConfigurator](diffs/v2EthAmmEthPoolConfigurator.md), [v2EthAmmPolPoolConfigurator](diffs/v2EthAmmPolPoolConfigurator.md), [v2EthAmmAvaPoolConfigurator](diffs/v2EthAmmAvaPoolConfigurator.md)

### Scripts for diffs:

- To generate all the source code diffs run: `make diff-contracts`.

- To generate all the storage layout code diffs run: `make storage-diff`.

- To download the source code from etherscan run: `download-all-etherscan`. This should be run once, when initializing the project.

- To validate different impl addresses of aave v3 stable debt tokens run: `npm run get-v3-stable-debt-impl`.

- To diff between the new deployed contracts and the previous one, run: `make download-deployed-contracts` to download the deployed contracts and `make diff-deployed-contracts` to diff them.

- The diffs between different aave v2 stable debt tokens on ethereum can be generated by running this command: `npm run generate-v2-eth-stable-debt-diff`.

### Diffs on deployed contracts:

You can find the diffs between the new deployed contracts and the previous version of them

| Diff                                            | Contract            | Previous                                                                                                              | New Deployed                                                                                                          |
| ----------------------------------------------- | ------------------- | --------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------- |
| [HERE](diffs/deployed/v2UsdtStableDebtToken.md) | v2 Stable Debt USDT | [0x9d4578c813d69745092a4f951753ed2b28056279](https://etherscan.io/address/0x9d4578c813d69745092a4f951753ed2b28056279) | [0xC61262D6ad449AC09B4087f46391Dd9A26b5888B](https://etherscan.io/address/0xC61262D6ad449AC09B4087f46391Dd9A26b5888B) |
| [HERE](diffs/deployed/v2WbtcStableDebtToken.md) | v2 Stable Debt WBTC | [0x6ac108c4c3fe7f4d367513f599da1b9df7c43433](https://etherscan.io/address/0x6ac108c4c3fe7f4d367513f599da1b9df7c43433) | [0x4f279f2046870F77cd9Ce63497f8A2D8689ef804](https://etherscan.io/address/0x4f279f2046870F77cd9Ce63497f8A2D8689ef804) |
| [HERE](diffs/deployed/v2WethStableDebtToken.md) | v2 Stable Debt WETH | [0xa558ea1a875f8b576f0728d32c39f62158e49b92](https://etherscan.io/address/0xa558ea1a875f8b576f0728d32c39f62158e49b92) | [0xEd14b4E51B04d4d0211474a721F77C0817166c2f](https://etherscan.io/address/0xEd14b4E51B04d4d0211474a721F77C0817166c2f) |
| [HERE](diffs/deployed/v2ZrxStableDebtToken.md)  | v2 Stable Debt ZRX  | [0x42a87bf47b5efd11fa9ddd5321bf9aa502233b74](https://etherscan.io/address/0x42a87bf47b5efd11fa9ddd5321bf9aa502233b74) | [0xffaCA447191d8196C8Cf96E5912b732063DE4307](https://etherscan.io/address/0xffaCA447191d8196C8Cf96E5912b732063DE4307) |
| [HERE](diffs/deployed/v2BatStableDebtToken.md)  | v2 Stable Debt BAT  | [0x917fd53da13edcce5c155a7dbc73e1e4dccd4267](https://etherscan.io/address/0x917fd53da13edcce5c155a7dbc73e1e4dccd4267) | [0x49B6645a9aa05f1Be24893136100467276399470](https://etherscan.io/address/0x49B6645a9aa05f1Be24893136100467276399470) |
| [HERE](diffs/deployed/v2EnjStableDebtToken.md)  | v2 Stable Debt ENJ  | [0x8286288f3c454b51dfc70bd0d6918220428b0741](https://etherscan.io/address/0x8286288f3c454b51dfc70bd0d6918220428b0741) | [0x0fB427f800C5E39E7d8029e19F515300d4bb22C2](https://etherscan.io/address/0x0fB427f800C5E39E7d8029e19F515300d4bb22C2) |
| [HERE](diffs/deployed/v2KncStableDebtToken.md)  | v2 Stable Debt KNC  | [0xf818b175353f023e3ec1a098d040778b835897c7](https://etherscan.io/address/0xf818b175353f023e3ec1a098d040778b835897c7) | [0x22a8FD718924ab2f9dd4D0326DD8ab99Ef21D0b3](https://etherscan.io/address/0x22a8FD718924ab2f9dd4D0326DD8ab99Ef21D0b3) |
| [HERE](diffs/deployed/v2LinkStableDebtToken.md) | v2 Stable Debt LINK | [0xadc313f17a3e2180f609a45d7b381a45e2e88a9f](https://etherscan.io/address/0xadc313f17a3e2180f609a45d7b381a45e2e88a9f) | [0x1B80694AF3D4e617c747423f992F532B8baE098b](https://etherscan.io/address/0x1B80694AF3D4e617c747423f992F532B8baE098b) |
| [HERE](diffs/deployed/v2ManaStableDebtToken.md) | v2 Stable Debt MANA | [0x441c5cd55e9e3267d02f7b1b4d245aa1c61891c3](https://etherscan.io/address/0x441c5cd55e9e3267d02f7b1b4d245aa1c61891c3) | [0xe0bf71fF662e8bbeb911ACEa765f4b8be052F59b](https://etherscan.io/address/0xe0bf71fF662e8bbeb911ACEa765f4b8be052F59b) |
| [HERE](diffs/deployed/v2MkrStableDebtToken.md)  | v2 Stable Debt MKR  | [0x20f9027c5092739c58250cf456642e8e3d4dbed5](https://etherscan.io/address/0x20f9027c5092739c58250cf456642e8e3d4dbed5) | [0xC4CFCE0b16199818Ad942a87902C9172ba005022](https://etherscan.io/address/0xC4CFCE0b16199818Ad942a87902C9172ba005022) |
| [HERE](diffs/deployed/v2RenStableDebtToken.md)  | v2 Stable Debt REN  | [0x7b3e7aea49a5f5d2514b9317d4cf58f828ac28c2](https://etherscan.io/address/0x7b3e7aea49a5f5d2514b9317d4cf58f828ac28c2) | [0x6F4B277366e10F68003A0a65Ef8f118f3D60B67E](https://etherscan.io/address/0x6F4B277366e10F68003A0a65Ef8f118f3D60B67E) |
| [HERE](diffs/deployed/v2UsdcStableDebtToken.md) | v2 Stable Debt USDC | [0x3b2a77058a1eb4403a90b94585fab16bc512e703](https://etherscan.io/address/0x3b2a77058a1eb4403a90b94585fab16bc512e703) | [0x8DFF7Fda82976452b6FB957F549944e7af7A3e6F](https://etherscan.io/address/0x8DFF7Fda82976452b6FB957F549944e7af7A3e6F) |
| [HERE](diffs/deployed/v2LusdStableDebtToken.md) | v2 Stable Debt LUSD | [0x595c33538215dc4b092f35afc85d904631263f4f](https://etherscan.io/address/0x595c33538215dc4b092f35afc85d904631263f4f) | [0x1363602E58e25929A15bE194a3D505Fd6F8BE751](https://etherscan.io/address/0x1363602E58e25929A15bE194a3D505Fd6F8BE751) |
| [HERE](diffs/deployed/v3PolStableDebtToken.md) | v3 Polygon Stable Debt | [0x50ddd0cd4266299527d25de9cbb55fe0eb8dac30](https://polygonscan.com/address/0x50ddd0cd4266299527d25de9cbb55fe0eb8dac30) | [0xf4294973b7e6f6c411dd8a388592e7c7d32f2486](https://polygonscan.com/address/0xf4294973b7e6f6c411dd8a388592e7c7d32f2486) |
| [HERE](diffs/deployed/v3ArbStableDebtToken.md) | v3 Arbitrum Stable Debt | [0x0c2c95b24529664fe55d4437d7a31175cfe6c4f7](https://arbiscan.io/address/0x0c2c95b24529664fe55d4437d7a31175cfe6c4f7) | [0xCB7113D3d572613BbFCeCf80d1341cFFE2A92C00](https://arbiscan.io/address/0xCB7113D3d572613BbFCeCf80d1341cFFE2A92C00) |
| [HERE](diffs/deployed/v3OptStableDebtToken.md) | v3 Optimism Stable Debt | [0x6b4e260b765b3ca1514e618c0215a6b7839ff93e](https://optimistic.etherscan.io/address/0x6b4e260b765b3ca1514e618c0215a6b7839ff93e) | [0x69713dA5fDfacf77E80C31F9B928Ec0Fc3716384](https://optimistic.etherscan.io/address/0x69713dA5fDfacf77E80C31F9B928Ec0Fc3716384) |
| [HERE](diffs/deployed/v3AvaStableDebtToken.md) | v3 Avalanche Stable Debt | [0x893411580e590d62ddbca8a703d61cc4a8c7b2b9](https://snowtrace.io/address/0x893411580e590d62ddbca8a703d61cc4a8c7b2b9) | [0xccf12894957E637Bd69693B12F3ba12b539C2D11](https://snowtrace.io/address/0xccf12894957E637Bd69693B12F3ba12b539C2D11) |
